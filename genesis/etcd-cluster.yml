# ====================================================================================
# ETCD 集群版配置文件
# ====================================================================================
# 描述: 用于生产环境或需要高可用性的ETCD三节点集群
# 网络: 使用 genesis-net 网络，集群内部通过主机名通信
# 存储: 每个节点使用独立的Docker卷进行数据持久化
# 访问: 仅暴露etcd-1的客户端端口2379到宿主机，其他节点通过内部网络访问
# 用途: 为应用程序提供高可用的分布式键值存储服务
# 特点: 三节点集群，支持自动故障转移和数据一致性
# ====================================================================================

# YAML锚点配置：定义共享配置模板，减少重复代码
x-etcd-common: &etcd-common
  # 使用官方ETCD镜像，版本3.5.12，经过充分测试的稳定版本
  image: quay.io/coreos/etcd:v3.5.12
  
  # 重启策略：除非手动停止，否则总是自动重启
  restart: unless-stopped

  # 网络配置：加入基础设施网络
  networks:
    # genesis-net是基础设施网络，所有基础服务都在此网络中
    # 集群内部通过主机名进行通信，无需暴露端口到外部
    - genesis-net
  
  # 资源限制配置：防止资源耗尽影响宿主机
  deploy:
    resources:
      limits:
        memory: 192M  # 最大内存限制，防止内存泄漏
      reservations:
        memory: 96M   # 最小内存预留，确保基本运行
  
  # 健康检查配置：定期检查服务状态，确保集群健康
  healthcheck:
    test: ["CMD", "etcdctl", "endpoint", "health"]  # 健康检查命令
    interval: 10s     # 每10秒检查一次
    timeout: 3s       # 超时时间3秒
    retries: 3        # 失败重试3次
    start_period: 15s # 启动等待时间，给服务充分启动时间
  
  # 日志配置：限制日志大小，防止磁盘空间耗尽
  logging:
    driver: json-file
    options:
      max-size: "5m"  # 单个日志文件最大5MB
      max-file: "2"   # 保留2个日志文件，循环使用

# ====================================================================================
# 服务定义
# ====================================================================================

services:
  # ===== ETCD 节点 1 (主节点 + 客户端访问入口) =====
  etcd-1:
    # 继承共享配置模板
    <<: *etcd-common
    
    # 容器名称，便于识别和管理
    container_name: genesis-etcd-1
    
    # 主机名，用于集群内部通信和服务发现
    hostname: etcd-1
    
    # 环境变量配置：定义集群行为和节点属性
    environment:
      # 使用ETCD API版本3，推荐的新版本API
      ETCDCTL_API: 3
      
      # 节点名称，在集群中唯一标识
      ETCD_NAME: etcd-1
      
      # 集群令牌，确保集群成员属于同一集群
      ETCD_INITIAL_CLUSTER_TOKEN: genesis-etcd-cluster
      
      # 初始集群状态：new表示新建集群
      ETCD_INITIAL_CLUSTER_STATE: new
      
      # 初始集群成员列表：包含所有3个节点的peer地址
      # 格式：节点名=http://主机名:2380
      ETCD_INITIAL_CLUSTER: etcd-1=http://etcd-1:2380,etcd-2=http://etcd-2:2380,etcd-3=http://etcd-3:2380
      
      # 本节点peer地址，用于集群内部通信
      ETCD_INITIAL_ADVERTISE_PEER_URLS: http://etcd-1:2380
      
      # 本节点客户端地址，告知客户端如何访问本节点
      ETCD_ADVERTISE_CLIENT_URLS: http://etcd-1:2379
      
      # 监听peer地址，允许所有网络接口的peer连接
      ETCD_LISTEN_PEER_URLS: http://0.0.0.0:2380
      
      # 监听客户端地址，允许所有网络接口的客户端连接
      ETCD_LISTEN_CLIENT_URLS: http://0.0.0.0:2379
      
      # 数据存储配额，1GB大小限制，防止磁盘空间耗尽
      ETCD_QUOTA_BACKEND_BYTES: 1073741824
      
      # 自动压缩保留期，1小时，定期清理旧数据
      ETCD_AUTO_COMPACTION_RETENTION: "1"
      
      # 快照计数，每5000次写操作触发一次快照
      ETCD_SNAPSHOT_COUNT: 5000
    
    # 数据卷配置：数据持久化存储
    volumes:
      # 使用Docker卷便于备份和迁移，与宿主机解耦
      - etcd-data-1:/etcd-data
    
    # 端口映射：仅etcd-1暴露客户端端口，作为集群访问入口
    # 限制为本地访问，提高安全性
    ports:
      - "127.0.0.1:2379:2379"
    # 说明：etcd-2和etcd-3不暴露端口，通过内部网络访问
    # 这样既保证了集群通信，又减少了攻击面

  # ===== ETCD 节点 2 (集群成员) =====
  etcd-2:
    # 继承共享配置模板
    <<: *etcd-common
    
    # 容器名称，便于识别和管理
    container_name: genesis-etcd-2
    
    # 主机名，用于集群内部通信和服务发现
    hostname: etcd-2
    
    # 环境变量配置：与etcd-1类似，但针对本节点定制
    environment:
      # 使用ETCD API版本3
      ETCDCTL_API: 3
      
      # 节点名称，在集群中唯一标识
      ETCD_NAME: etcd-2
      
      # 集群令牌，必须与etcd-1相同
      ETCD_INITIAL_CLUSTER_TOKEN: genesis-etcd-cluster
      
      # 初始集群状态：new表示新建集群
      ETCD_INITIAL_CLUSTER_STATE: new
      
      # 初始集群成员列表：必须与etcd-1完全相同
      ETCD_INITIAL_CLUSTER: etcd-1=http://etcd-1:2380,etcd-2=http://etcd-2:2380,etcd-3=http://etcd-3:2380
      
      # 本节点peer地址
      ETCD_INITIAL_ADVERTISE_PEER_URLS: http://etcd-2:2380
      
      # 本节点客户端地址
      ETCD_ADVERTISE_CLIENT_URLS: http://etcd-2:2379
      
      # 监听peer地址
      ETCD_LISTEN_PEER_URLS: http://0.0.0.0:2380
      
      # 监听客户端地址
      ETCD_LISTEN_CLIENT_URLS: http://0.0.0.0:2379
      
      # 数据存储配额
      ETCD_QUOTA_BACKEND_BYTES: 1073741824
      
      # 自动压缩保留期
      ETCD_AUTO_COMPACTION_RETENTION: "1"
      
      # 快照计数
      ETCD_SNAPSHOT_COUNT: 5000
    
    # 数据卷配置
    volumes:
      - etcd-data-2:/etcd-data
    # 注意：etcd-2不暴露任何端口到宿主机，通过内部网络访问

  # ===== ETCD 节点 3 (集群成员) =====
  etcd-3:
    # 继承共享配置模板
    <<: *etcd-common
    
    # 容器名称，便于识别和管理
    container_name: genesis-etcd-3
    
    # 主机名，用于集群内部通信和服务发现
    hostname: etcd-3
    
    # 环境变量配置：与etcd-1类似，但针对本节点定制
    environment:
      # 使用ETCD API版本3
      ETCDCTL_API: 3
      
      # 节点名称，在集群中唯一标识
      ETCD_NAME: etcd-3
      
      # 集群令牌，必须与etcd-1相同
      ETCD_INITIAL_CLUSTER_TOKEN: genesis-etcd-cluster
      
      # 初始集群状态：new表示新建集群
      ETCD_INITIAL_CLUSTER_STATE: new
      
      # 初始集群成员列表：必须与etcd-1完全相同
      ETCD_INITIAL_CLUSTER: etcd-1=http://etcd-1:2380,etcd-2=http://etcd-2:2380,etcd-3=http://etcd-3:2380
      
      # 本节点peer地址
      ETCD_INITIAL_ADVERTISE_PEER_URLS: http://etcd-3:2380
      
      # 本节点客户端地址
      ETCD_ADVERTISE_CLIENT_URLS: http://etcd-3:2379
      
      # 监听peer地址
      ETCD_LISTEN_PEER_URLS: http://0.0.0.0:2380
      
      # 监听客户端地址
      ETCD_LISTEN_CLIENT_URLS: http://0.0.0.0:2379
      
      # 数据存储配额
      ETCD_QUOTA_BACKEND_BYTES: 1073741824
      
      # 自动压缩保留期
      ETCD_AUTO_COMPACTION_RETENTION: "1"
      
      # 快照计数
      ETCD_SNAPSHOT_COUNT: 5000
    
    # 数据卷配置
    volumes:
      - etcd-data-3:/etcd-data
    # 注意：etcd-3不暴露任何端口到宿主机，通过内部网络访问

# ====================================================================================
# 网络和存储配置
# ====================================================================================

# 网络定义：使用外部已创建的genesis-net网络
networks:
  genesis-net:
    external: true
    # 说明：genesis-net是基础设施网络，所有基础服务都在此网络中
    # 创建命令：docker network create genesis-net
    # 用途：为基础设施服务提供内部通信网络

# 存储卷定义：数据持久化存储
volumes:
  etcd-data-1:
    # 说明：etcd-1的数据卷，存储节点1的所有数据
    # 优点：与宿主机解耦，便于备份和容器迁移
    # 管理：docker volume ls / docker volume inspect etcd-data-1
  etcd-data-2:
    # 说明：etcd-2的数据卷，存储节点2的所有数据
  etcd-data-3:
    # 说明：etcd-3的数据卷，存储节点3的所有数据

# ====================================================================================
# 使用说明和运维指南
# ====================================================================================
# 启动集群:
#   docker compose -f etcd-cluster.yml up -d
#
# 查看集群状态:
#   docker compose -f etcd-cluster.yml ps
#
# 查看节点成员列表:
#   docker exec -it genesis-etcd-1 etcdctl member list
#
# 检查集群健康状态:
#   docker exec -it genesis-etcd-1 etcdctl endpoint health --cluster
#
# 查看集群端点状态:
#   docker exec -it genesis-etcd-1 etcdctl endpoint status --cluster
#
# 数据操作（通过etcd-1访问整个集群）:
#   docker exec -it genesis-etcd-1 etcdctl put mykey "my value"
#   docker exec -it genesis-etcd-1 etcdctl get mykey
#
# 查看日志:
#   docker compose -f etcd-cluster.yml logs -f etcd-1
#
# 停止集群:
#   docker compose -f etcd-cluster.yml down
#
# 数据备份（备份整个集群）:
#   docker exec -it genesis-etcd-1 etcdctl snapshot save /etcd-data/backup.db
#   docker cp genesis-etcd-1:/etcd-data/backup.db ./backup.db
#
# 集群扩容（添加新节点）:
#   1. 添加新成员: etcdctl member add etcd4 --peer-urls=http://etcd4:2380
#   2. 启动新节点: 使用类似配置启动etcd4容器
#   3. 验证集群: etcdctl member list
#
# 故障处理:
#   - 如果某个节点失败，集群仍然可以提供服务（需要多数节点存活）
#   - 重启失败的容器通常可以恢复服务
#   - 查看日志: docker compose -f etcd-cluster.yml logs 失败节点名称
#
# 性能调优:
#   - 根据实际负载调整内存限制
#   - 监控磁盘I/O性能，考虑使用SSD
#   - 调整快照频率和压缩策略
# ====================================================================================